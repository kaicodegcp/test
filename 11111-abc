Let‚Äôs fix it in the nacho namespace step by step:
This is a known Cloudera CDS vault failure, when the vault image cannot be pulled because the newly created ServiceAccounts do not have access to your registry.

üîß Step-by-Step Fix for CDS Install Failure in Namespace nacho
Step 1: Patch the default ServiceAccount
Since vault-0 starts from the default SA, attach your imagePullSecret:

bash
Copy
Edit
oc patch serviceaccount default \
  -p '{"imagePullSecrets": [{"name": "my-registry-secret"}]}' \
  -n nacho
Step 2: Patch all service accounts that CDS installer will create
bash
Copy
Edit
for sa in vault-sa vault-auth drs-admin; do
  oc patch serviceaccount "$sa" \
    -p '{"imagePullSecrets": [{"name": "my-registry-secret"}]}' \
    -n nacho
done
Verify:

bash
Copy
Edit
oc get sa default vault-sa vault-auth drs-admin -n nacho -o yaml | grep -A 2 imagePullSecrets
You should see:

yaml
Copy
Edit
imagePullSecrets:
- name: my-registry-secret
Step 3: Patch OpenShift global trust with your registry cert
Ensure your cert is still available and trusted:

bash
Copy
Edit
oc create configmap registry-certs \
  --from-file=sd-wv58-kflz.nam.nsroot.net..5000=/opt/registry/certs/domain.crt \
  -n openshift-config --dry-run=client -o yaml | oc apply -f -

oc patch image.config.openshift.io/cluster \
  --type=merge \
  -p '{"spec":{"additionalTrustedCA":{"name":"registry-certs"}}}'
‚úÖ Step 4: Retry the Cloudera CDS Install Wizard
Go to the wizard screen for namespace nacho

Click Retry

Vault pod should now succeed because the image pull secret is valid and certs are trusted

üß™ Optional: Pre-Test Before Retrying Wizard
To confirm fix before retrying install, run:

bash
Copy
Edit
oc run vault-test-ok \
  --image=sd-wv58-kflz.nam.nsroot.net:5000/cdp-private/cloudera_thirdparty/vault:1.17.2-r0 \
  --restart=Never -n nacho
Then check:

bash
Copy
Edit
oc get pod vault-test-ok -n nacho
It should go to Completed or Running. That confirms everything is working.

Let me know once you try this. If vault still fails, we can review specific vault-0 logs with:

bash
Copy
Edit
oc logs statefulset/vault -n nacho



==========================

What You Have Already Done Correctly
Registry Secret Patched to Default ServiceAccount in nacho

You patched default with my-registry-secret using:

bash
Copy
Edit
oc patch serviceaccount default \
  -p '{"imagePullSecrets": [{"name": "my-registry-secret"}]}' -n nacho
Verified via:

bash
Copy
Edit
oc get sa default -n nacho -o yaml | grep imagePullSecrets -A2
TLS Certificate Re-created and Patched into openshift-config

You re-created the ConfigMap:

bash
Copy
Edit
oc create configmap registry-certs --from-file=... -n openshift-config --dry-run=client -o yaml | oc apply -f -
Patched cluster-wide trusted CAs:

bash
Copy
Edit
oc patch image.config.openshift.io/cluster \
  --type=merge \
  -p '{"spec":{"additionalTrustedCA":{"name":"registry-certs"}}}'
Manual Pod vault-test-ok in nacho

You ran this and it succeeded:

bash
Copy
Edit
oc run vault-test-ok --image=sd-wv58-kflz.nam.nsroot.net:5000/... --restart=Never -n nacho
Verified via describe and logs

Pod successfully pulled image, started, and ran.

Status showed Started container vault-test-ok.

‚ùå CDS Wizard Still Fails
Even though manual vault-test-ok pod succeeded, the CDS installation wizard is failing at:

vbnet
Copy
Edit
Vault was not able to start.
Cause: incorrect Docker registry settings or rook/ceph volume claims
‚úÖ Conclusion
You do not need to run manual patches again. Your setup is good. The issue now is Cloudera's internal Helm chart logic ‚Äî likely still pointing to stale values or failed jobs from a prior attempt.

üîß Recommended Next Steps
Clean the Namespace nacho Completely
Cloudera's CDS wizard is sensitive to partial state from failed attempts. Clean and retry:

bash
Copy
Edit
oc delete all --all -n nacho
oc delete pvc --all -n nacho
oc delete secrets --all -n nacho
oc delete configmap --all -n nacho
oc delete serviceaccount vault-sa vault-auth drs-admin -n nacho --ignore-not-found
Retry Wizard in nacho

Make sure:

vault-0 pod is created automatically (do not run it manually again).

TLS and secret setup already exist (you've done it).

Optional: Try a New Namespace (if error persists)

Create and pre-patch new namespace:

bash
Copy
Edit
oc create ns nacho2
oc patch serviceaccount default -p '{"imagePullSecrets": [{"name": "my-registry-secret"}]}' -n nacho2




--------------
oc patch sa default -p '{"imagePullSecrets":[{"name":"my-registry-secret"}]}' -n nacho



==================

ix: Use anyuid or privileged SCC
Cloudera CDS components (like Vault) need anyuid SCC or elevated permissions.

Run this to assign the correct SCC to the default service account in your namespace (nacho):

bash
Copy
Edit
oc adm policy add-scc-to-user anyuid -z default -n nacho
If the vault-sa account exists, you can also run:

bash
Copy
Edit
oc adm policy add-scc-to-user anyuid -z vault-sa -n nacho


-----------------

Final Fix: Use privileged SCC
Run:

bash
Copy
Edit
oc adm policy add-scc-to-user privileged -z default -n nacho
And also for vault-sa if needed:

bash
Copy
Edit
oc adm policy add-scc-to-user privileged -z vault-sa -n nacho
üîÅ Then:
Delete the test pod again and recreate:

bash
Copy
Edit
oc delete pod vault-test-ok -n nacho

oc run vault-test-ok \
  --image=sd-wv58-kflz.nam.nsroot.net:5000/cdp-private/cloudera_thirdparty/vault:1.17.2-r0 \
  --restart=Never -n nacho
üîç What to Expect
Now when you run:

bash
Copy
Edit
oc get pods -n nacho
oc logs vault-test-ok -n nacho




=============

Final Fix ‚Äî Patch the Pod with securityContext (Explicit Capabilities)
To force-enable this, test with a YAML that grants the needed capabilities explicitly.

Create this pod YAML:

yaml
Copy
Edit
apiVersion: v1
kind: Pod
metadata:
  name: vault-test-fixed
  namespace: nacho
spec:
  containers:
  - name: vault
    image: sd-wv58-kflz.nam.nsroot.net:5000/cdp-private/cloudera_thirdparty/vault:1.17.2-r0
    securityContext:
      privileged: true
      capabilities:
        add:
          - SETFCAP
  restartPolicy: Never
  serviceAccountName: default
Then apply it:

bash
Copy
Edit
oc apply -f vault-test-fixed.yaml
üîç Validate:
bash
Copy
Edit
oc get pods -n nacho
oc logs vault-test-fixed -n nacho
üîÅ If this works
Then Cloudera CDS vault pods must be patched to inherit these capabilities ‚Äî but normally privileged SCC is enough. If not, verify SCC assignment is taking effect:

bash
Copy
Edit
oc get pod vault-test-fixed -n nacho -o jsonpath='{.spec.securityContext}'
oc describe pod vault-test-fixed -n nacho | grep -i scc




============

Update the vault-nacho.yaml to use the correct secret:

yaml
Copy
Edit
imagePullSecrets:
  - name: my-registry-secret
Or if docker-creds is the correct one, make sure it exists:

bash
Copy
Edit
oc get secret docker-creds -n nacho
If it doesn't exist:

bash
Copy
Edit
oc create secret docker-registry docker-creds \
  --docker-server=sd-wv58-kflz.nam.nsroot.net:5000 \
  --docker-username=admin \
  --docker-password=admin \
  -n nacho
Then reapply the pod:

bash
Copy
Edit
oc delete pod vault-0 -n nacho
oc apply -f vault-nacho.yaml


==============================

mkdir -p /mnt/test-nfs
mount -t nfs gtdvnasapp0004.wlb2.nam.nsroot.net:/trident_pvc_26dcfdb0_9e62_4d25_a1a7_6a913cc6a2f5 /mnt/test-nfs
